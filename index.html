<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quản lý Text — 2 cột (1-9 | 10-18)</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;max-width:1200px;margin:18px auto;padding:8px}
  h1{margin-bottom:10px}
  .board{display:flex;gap:16px}
  .col{flex:1;min-width:0}
  .col h2{font-size:16px;margin:6px 0 10px}
  .row{display:flex;align-items:center;gap:8px;margin-bottom:10px;padding:10px;border:1px solid #ddd;border-radius:6px;background:#fff}
  /* responsive: stack columns */
  @media (max-width:980px){ .board{flex-direction:column} }
  .row-number{width:36px;height:36px;border-radius:50%;background:#e6f7ff;color:#007bff;display:flex;align-items:center;justify-content:center;font-weight:700}
  .text-input{flex:1;padding:6px;border:1px solid #ddd;border-radius:4px}
  .note-input{width:130px;padding:6px;border:1px solid #ddd;border-radius:4px}
  .button{padding:6px 10px;border-radius:4px;border:none;color:#fff;cursor:pointer}
  .paste-btn{background:#28a745}
  .send-btn{background:#17a2b8}
  .copy-btn{background:#007bff}
  .delete-btn{background:#dc3545}
  .remove-row-btn{background:#ff6b6b}
  .small{font-size:13px;color:#333}
  .counts{display:flex;flex-direction:column;gap:3px;align-items:flex-start;margin-left:6px}
  .copy-adjust-btn{padding:4px 8px;background:#6c757d;color:#fff;border-radius:4px;border:none;cursor:pointer}
  .agent-select{width:110px;padding:6px;border-radius:4px;border:1px solid #ccc}
  .controls{display:flex;gap:6px;align-items:center}
  .footer{margin-top:12px;padding:10px;border:1px solid #ddd;border-radius:6px;text-align:center}
  .add-row-btn{background:#28a745;color:#fff;padding:8px 14px;border-radius:6px;border:none;cursor:pointer}
  /* toast */
  .toast{position:fixed;right:18px;bottom:18px;background:#28a745;color:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.18);z-index:2147483647;opacity:1;transition:opacity .3s,transform .25s}
  .toast.error{background:#dc3545}
</style>
</head>
<body>
  <h1>Quản lý Text</h1>

  <div class="board">
    <div class="col" id="col-left">
      <h2>STT 1 → 9</h2>
      <div id="left-rows"></div>
    </div>

    <div class="col" id="col-right">
      <h2>STT 10 → 18</h2>
      <div id="right-rows"></div>
    </div>
  </div>

  <div style="text-align:center;margin-top:12px">
    <button class="add-row-btn" onclick="resetToDefault()">Reset 18 rows</button>
  </div>

  <div class="footer">
    <div class="small">Tổng số lần dán: <span id="total-paste">0</span> — Tổng số link duy nhất: <span id="total-links">0</span> <button onclick="showLinksModal()" style="margin-left:10px;padding:6px 10px;border-radius:6px;border:none;background:#007bff;color:#fff;cursor:pointer">Xem Links</button></div>
  </div>

  <div id="links-modal" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;padding:14px;border:1px solid #ddd;border-radius:8px;z-index:9999;max-width:820px;width:90%;max-height:70vh;overflow:auto">
    <h3>Danh sách link</h3>
    <ul id="links-list"></ul>
    <div style="margin-top:8px"><button onclick="deleteAllLinks()" style="background:#dc3545;color:#fff;padding:8px 12px;border:none;border-radius:6px;cursor:pointer">Xóa tất cả</button> <button onclick="closeLinksModal()" style="padding:8px 12px;border-radius:6px;border:none;cursor:pointer">Đóng</button></div>
  </div>

<script>
/* ========== CONFIG ========== */
const API_URL = 'https://844aace9e015.ngrok-free.app/push'; // <-- đổi nếu cần
const SECRET_TOKEN = 'MY_SECRET_TOKEN_ChangeMe'; // <-- đổi giống server
const MAX_ROWS = 18;
const LEFT_COUNT = 9; // left shows 1..9, right shows 10..18

/* ========== state ========== */
let rowData = [];   // each: { text, note, agent }
let pasteCounts = [];
let copyCounts = [];
let uniqueLinks = [];

/* storage key */
function storageKey(){ return 'textManager_2col_v1' }

/* helpers */
function isValidUrl(s){ return /^(https?:\/\/[^\s/$.?#].[^\s]*)$/i.test(String(s||'').trim()) }
function saveState(){
  const payload = { rowData, pasteCounts, copyCounts, uniqueLinks, ts: new Date().toISOString() };
  localStorage.setItem(storageKey(), JSON.stringify(payload));
}
function loadState(){
  const raw = localStorage.getItem(storageKey());
  if(!raw){
    // init default 18 rows
    rowData = Array(MAX_ROWS).fill(0).map(()=>({ text:'', note:'', agent:'' }));
    pasteCounts = Array(MAX_ROWS).fill(0);
    copyCounts = Array(MAX_ROWS).fill(0);
    uniqueLinks = [];
    renderAll();
    updateTotals();
    return;
  }
  try{
    const obj = JSON.parse(raw);
    rowData = obj.rowData && obj.rowData.length===MAX_ROWS ? obj.rowData : (Array(MAX_ROWS).fill(0).map(()=>({ text:'', note:'', agent:'' })));
    pasteCounts = obj.pasteCounts && obj.pasteCounts.length===MAX_ROWS ? obj.pasteCounts : Array(MAX_ROWS).fill(0);
    copyCounts = obj.copyCounts && obj.copyCounts.length===MAX_ROWS ? obj.copyCounts : Array(MAX_ROWS).fill(0);
    uniqueLinks = obj.uniqueLinks || [];
  }catch(e){
    rowData = Array(MAX_ROWS).fill(0).map(()=>({ text:'', note:'', agent:'' }));
    pasteCounts = Array(MAX_ROWS).fill(0);
    copyCounts = Array(MAX_ROWS).fill(0);
    uniqueLinks = [];
  }
  renderAll();
  updateTotals();
}

/* render helpers */
function buildAgentSelect(selected){
  let s = '<select class="agent-select">';
  for(let i=1;i<=MAX_ROWS;i++) s += `<option value="${i}" ${String(i)===String(selected)?'selected':''}>Agent ${i}</option>`;
  s += '</select>';
  return s;
}

function makeRowHtml(index){ // index: 0..17
  const id = index+1;
  const data = rowData[index] || { text:'', note:'', agent:'' };
  const textEsc = (data.text||'').replace(/"/g,'&quot;');
  const agentHtml = buildAgentSelect(data.agent || '');
  return `
    <div class="row" data-id="${id}">
      <div class="row-number">${id}</div>
      <input class="text-input" value="${textEsc}" placeholder="Nhập văn bản..." />
      <div class="controls">
        <button class="button paste-btn" onclick="pasteText(${id})">Dán</button>
        <button class="button send-btn" onclick="sendToAgent(${id})">Gửi</button>
        <button class="button copy-btn" onclick="copyText(${id})">Copy</button>
        <button class="button delete-btn" onclick="deleteText(${id})">Delete</button>
      </div>
      <div class="counts small">
        <div class="paste-count">Dán: ${pasteCounts[id-1]||0} lần</div>
        <div class="copy-count">Copy: ${copyCounts[id-1]||0} lần</div>
      </div>
      ${agentHtml}
      <textarea class="note-input" placeholder="Ghi chú...">${data.note||''}</textarea>
    </div>
  `;
}

/* render left and right */
function renderAll(){
  const left = document.getElementById('left-rows');
  const right = document.getElementById('right-rows');
  left.innerHTML = '';
  right.innerHTML = '';

  for(let i=0;i<LEFT_COUNT;i++){
    const wrap = document.createElement('div');
    wrap.innerHTML = makeRowHtml(i);
    left.appendChild(wrap.firstElementChild);
  }
  for(let i=LEFT_COUNT;i<MAX_ROWS;i++){
    const wrap = document.createElement('div');
    wrap.innerHTML = makeRowHtml(i);
    right.appendChild(wrap.firstElementChild);
  }

  // attach event listeners for inputs, selects, noteareas
  document.querySelectorAll('.row').forEach(rowEl => {
    const id = parseInt(rowEl.getAttribute('data-id'));
    const idx = id-1;
    const input = rowEl.querySelector('.text-input');
    input.addEventListener('input', e => { rowData[idx].text = e.target.value; saveState(); });

    const select = rowEl.querySelector('.agent-select');
    select.addEventListener('change', e => { rowData[idx].agent = e.target.value; saveState(); });

    const note = rowEl.querySelector('.note-input');
    note.addEventListener('input', e => { rowData[idx].note = e.target.value; saveState(); });
  });
}

/* totals */
function updateTotals(){
  const totalPaste = pasteCounts.reduce((s,c)=>s+(c||0),0);
  document.getElementById('total-paste').textContent = totalPaste;
  document.getElementById('total-links').textContent = (uniqueLinks||[]).length;
}

/* clipboard / actions */
async function pasteText(rowId){
  const idx = rowId-1;
  try{
    const txt = await navigator.clipboard.readText();
    rowData[idx].text = txt;
    pasteCounts[idx] = (pasteCounts[idx]||0)+1;
    copyCounts[idx] = (copyCounts[idx]||0)+1; // keep earlier behavior
    if(isValidUrl(txt) && !uniqueLinks.some(u=>u.url===txt)) uniqueLinks.push({ url: txt, timestamp: new Date().toISOString() });
    saveState();
    renderAll();
    updateTotals();
    showToast('Đã dán');
  }catch(e){ console.error(e); alert('Lỗi dán: kiểm tra quyền clipboard'); }
}

function copyText(rowId){
  const idx = rowId-1;
  const text = rowData[idx].text || '';
  navigator.clipboard.writeText(text).then(()=>{
    copyCounts[idx] = (copyCounts[idx]||0)+1;
    saveState();
    renderAll();
    updateTotals();
    showToast('Đã copy');
  }).catch(e => { alert('Lỗi copy: '+e.message); });
}

function deleteText(rowId){
  const idx = rowId-1;
  rowData[idx].text = '';
  rowData[idx].note = '';
  rowData[idx].agent = '';
  pasteCounts[idx] = 0;
  copyCounts[idx] = 0;
  saveState();
  renderAll();
  updateTotals();
  showToast('Đã xóa');
}

/* send to server (per-row agent select fallback to localStorage nreer_agent_id or default 1) */
async function sendToAgent(rowId){
  const idx = rowId-1;
  const link = (rowData[idx].text||'').trim();
  if(!link){ showToast('Chưa có link để gửi', true); return; }
  if(!isValidUrl(link) && !confirm('Link có vẻ không chuẩn http(s). Vẫn gửi?')) return;

  const chosen = rowData[idx].agent && rowData[idx].agent.trim() ? rowData[idx].agent.trim() : null;
  const fallback = localStorage.getItem('nreer_agent_id') || null;
  const agentTo = chosen || fallback || '1';

  const payload = { token: SECRET_TOKEN, targetAgent: agentTo, link };
  try{
    const resp = await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const j = await resp.json().catch(()=>({ ok:false, error:'invalid_json' }));
    if(resp.ok && j.ok){
      showToast(`Đã gửi tới Agent ${agentTo}`);
    } else {
      showToast('Gửi thất bại: ' + (j.error || JSON.stringify(j)), true);
    }
  }catch(e){
    console.error(e);
    showToast('Lỗi khi gửi', true);
  }
}

/* links modal */
function showLinksModal(){
  const list = document.getElementById('links-list');
  list.innerHTML = '';
  if((uniqueLinks||[]).length===0) list.innerHTML = '<li>Chưa có link nào</li>';
  else {
    uniqueLinks.forEach(u => {
      const li = document.createElement('li');
      li.style.padding = '6px 0';
      li.innerHTML = `<span style="display:inline-block;width:70%">${u.url}</span> <small style="color:#666">${new Date(u.timestamp).toLocaleTimeString()}</small> <button style="margin-left:8px;padding:4px 8px;background:#dc3545;color:#fff;border:none;border-radius:6px;cursor:pointer" onclick="removeLink('${u.url.replace(/'/g,"\\'")}')">Xóa</button>`;
      list.appendChild(li);
    });
  }
  document.getElementById('links-modal').style.display = 'block';
}
function closeLinksModal(){ document.getElementById('links-modal').style.display = 'none' }
function removeLink(url){ uniqueLinks = uniqueLinks.filter(u=>u.url!==url); saveState(); showLinksModal(); updateTotals(); }
function deleteAllLinks(){ uniqueLinks = []; saveState(); showLinksModal(); updateTotals(); }

/* utilities */
function showToast(msg, isError=false){
  const t = document.createElement('div');
  t.className = 'toast' + (isError ? ' error' : '');
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(()=>{ t.style.opacity = '0'; t.style.transform = 'translateY(8px)'; }, 1200);
  setTimeout(()=> t.remove(), 1700);
}

/* reset to default 18 rows (clear data) */
function resetToDefault(){
  if(!confirm('Reset toàn bộ dữ liệu về 18 hàng trống?')) return;
  localStorage.removeItem(storageKey());
  loadState();
  showToast('Đã reset');
}

/* init */
window.addEventListener('load', ()=>{
  loadState();
  // re-render totals every few seconds in case counts changed externally
  setInterval(()=>updateTotals(), 1000);
});

/* expose for debug */
window.__textTwoCol = { loadState, saveState, sendToAgent, deleteAllLinks };
</script>
</body>
</html>
