<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Quản lý Text (Sender) — configured for ngrok</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    /* CSS ngắn gọn (giữ giống file bạn dùng) */
    body { font-family: Arial, sans-serif; max-width: 1000px; margin: 20px auto; padding: 0 10px; }
    .row { display:flex; align-items:center; margin-bottom:10px; padding:10px; border:1px solid #ccc; border-radius:5px;}
    .row-number { width:30px; font-weight:bold; text-align:center; margin-right:10px; font-size:18px; background:#e0f7fa; border-radius:50%; padding:5px; color:#007bff; }
    .text-input { flex:1; padding:8px; margin-right:10px; border:1px solid #ddd; border-radius:4px; }
    .note-input { width:150px; height:40px; padding:8px; margin-left:10px; border:1px solid #ddd; border-radius:4px; resize:none; }
    .button { padding:8px 12px; margin-right:5px; border:none; border-radius:4px; cursor:pointer; color:white; }
    .paste-btn { background:#28a745; }
    .copy-btn { background:#007bff; }
    .delete-btn { background:#dc3545; }
    .send-agent-btn { background:#17a2b8; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; }
    .agent-select { width:120px; margin-left:10px; margin-right:10px; }
  </style>
</head>
<body>
  <h1>Quản lý Text (Sender)</h1>
  <div id="rows"></div>
  <button onclick="addRow()">Thêm hàng</button>

<script>
/* ===== CONFIG: dùng ngrok domain bạn báo ===== */
const API_URL = 'https://844aace9e015.ngrok-free.app/push'; // <-- ngrok URL + /push
const SECRET_TOKEN = 'MY_SECRET_TOKEN_ChangeMe'; // <-- phải giống server
const MAX_AGENTS = 18; // set 9 hoặc 18 tùy bạn

/* ===== state ===== */
let rowData = [];
let pasteCounts = [];
let copyCounts = [];
let uniqueLinks = [];

/* helpers */
function isValidUrl(s){ return /^(https?:\/\/[^\s/$.?#].[^\s]*)$/i.test(String(s||'').trim()); }
function saveData(){ localStorage.setItem('sender_v1', JSON.stringify({rowData,pasteCounts,copyCounts,uniqueLinks})); }
function loadData(){
  const saved = localStorage.getItem('sender_v1');
  if(saved){
    const o = JSON.parse(saved);
    rowData = o.rowData || [];
    pasteCounts = o.pasteCounts || [];
    copyCounts = o.copyCounts || [];
    uniqueLinks = o.uniqueLinks || [];
  } else {
    rowData = Array(MAX_AGENTS).fill(0).map((_,i)=>({ text:'', note:'', agent: String(i+1) }));
    pasteCounts = Array(MAX_AGENTS).fill(0);
    copyCounts = Array(MAX_AGENTS).fill(0);
  }
  renderRows();
}

function buildAgentSelectHtml(selected){
  let html = '<select class="agent-select">';
  for(let i=1;i<=MAX_AGENTS;i++){
    html += `<option value="${i}" ${String(i)===String(selected)?'selected':''}>Agent ${i}</option>`;
  }
  html += '</select>';
  return html;
}

function renderRows(){
  const container = document.getElementById('rows');
  container.innerHTML = '';
  rowData.forEach((r, idx)=>{
    const id = idx+1;
    const row = document.createElement('div');
    row.className = 'row';
    row.innerHTML = `
      <span class="row-number">${id}</span>
      <input class="text-input" value="${(r.text||'').replace(/"/g,'&quot;')}" placeholder="Nhập link...">
      <button class="button paste-btn" onclick="pasteText(${id})">Dán</button>
      <button class="button copy-btn" onclick="copyText(${id})">Copy</button>
      <button class="button delete-btn" onclick="clearRow(${id})">Xóa</button>
      ${buildAgentSelectHtml(r.agent||String(id))}
      <button class="send-agent-btn" onclick="sendToAgent(${id})">Gửi</button>
    `;
    container.appendChild(row);

    // attach change listener for input & select
    row.querySelector('.text-input').addEventListener('input', (e)=>{
      rowData[idx].text = e.target.value;
      saveData();
    });
    row.querySelector('.agent-select').addEventListener('change', (e)=>{
      rowData[idx].agent = e.target.value;
      saveData();
    });
  });
}

function addRow(){
  rowData.push({ text:'', note:'', agent: String(rowData.length+1) });
  pasteCounts.push(0); copyCounts.push(0);
  renderRows(); saveData();
}

async function pasteText(rowId){
  try{
    const txt = await navigator.clipboard.readText();
    const idx = rowId-1;
    rowData[idx].text = txt;
    pasteCounts[idx] = (pasteCounts[idx]||0)+1;
    if(isValidUrl(txt) && !uniqueLinks.some(a=>a.url===txt)) uniqueLinks.push({url:txt,ts:Date.now()});
    renderRows(); saveData();
  }catch(e){
    alert('Lỗi dán: ' + e.message);
  }
}

function copyText(rowId){
  const idx = rowId-1;
  const txt = rowData[idx].text || '';
  navigator.clipboard.writeText(txt).then(()=>{
    copyCounts[idx] = (copyCounts[idx]||0)+1;
    saveData();
  }).catch(e => alert('Lỗi copy: '+e.message));
}

function clearRow(rowId){
  const idx = rowId-1;
  rowData[idx].text = ''; saveData(); renderRows();
}

/* ===== send to server ===== */
async function sendToAgent(rowId){
  const idx = rowId-1;
  const agent = rowData[idx].agent || String(rowId);
  const link = (rowData[idx].text||'').trim();
  if(!link) return alert('Chưa có link để gửi');
  if(!isValidUrl(link) && !confirm('Link có vẻ không phải http(s). Vẫn gửi?')) return;

  try{
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token: SECRET_TOKEN, targetAgent: agent, link })
    });
    const j = await res.json();
    if (j.ok) {
    showToast(`Đã gửi tới Agent ${agent}`);
} else {
    showToast(`Gửi thất bại: ${j.error || JSON.stringify(j)}`, true);
}

  }catch(e){
    alert('Gửi thất bại: ' + e.message);
  }
}

/* init */
window.addEventListener('load', ()=>{ loadData(); });
</script>
</body>
</html>
