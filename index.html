<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quản lý Text — 2 cột (1-9 | 10-18)</title>
<style>
  *,*::before,*::after{box-sizing:border-box}
  :root{
    --max-width:1360px;
    --gap:16px;
    --row-padding:8px;
    --accent:#007bff;
    --muted:#666;
  }
  body{font-family:Inter, "Segoe UI", Arial, Helvetica, sans-serif; background:#fafafa; margin:12px; color:#222; display:flex; justify-content:center}
  .container{width:100%; max-width:var(--max-width); padding:6px 18px 40px; background:transparent}
  h1{font-size:22px;margin:8px 0 6px}
  .board{display:grid;grid-template-columns:1fr 1fr; gap:var(--gap); align-items:start}
  @media (max-width:980px){ .board{grid-template-columns:1fr} }

  .col{background:transparent}
  .col h2{font-size:14px;margin:6px 0 10px;color:var(--muted)}

  .row{display:grid;grid-template-columns:56px 1fr auto; gap:8px;align-items:center;padding:var(--row-padding);border:1px solid #e6e6e6;border-radius:8px;background:#fff}
  .row-number{width:40px;height:40px;border-radius:50%;background:#e9f6ff;color:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;cursor:pointer;user-select:none}
  .row-number.editing{background:#fff;border:1px solid #ddd; padding:0}
  .text-input{width:100%;padding:8px 10px;border:1px solid #e0e0e0;border-radius:6px;font-size:13px;color:#111; overflow:hidden}
  .text-input::selection{background:#b3d4ff}
  .note-input{width:140px;padding:8px;border:1px solid #e0e0e0;border-radius:6px;font-size:13px;resize:none;height:36px}
  .controls{display:flex;gap:8px;align-items:center}
  .button{padding:7px 10px;border-radius:6px;border:none;color:#fff;cursor:pointer;font-size:13px}
  .paste-btn{background:#28a745}
  .send-btn{background:#17a2b8}
  .copy-btn{background:#007bff}
  .delete-btn{background:#dc3545}
  .agent-select{width:110px;padding:6px;border-radius:6px;border:1px solid #ddd;background:#fff;font-size:13px}
  .counts{display:flex;flex-direction:column;align-items:flex-start;gap:4px;font-size:13px;color:var(--muted);margin-left:6px}
  .row-right{display:flex;flex-direction:column;gap:6px;align-items:flex-end;min-width:190px}
  .small{font-size:12px;color:var(--muted)}
  .add-row-btn{background:#28a745;color:#fff;padding:8px 14px;border-radius:6px;border:none;cursor:pointer}
  #links-modal{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;padding:14px;border:1px solid #ddd;border-radius:8px;z-index:9999;max-width:900px;width:94%;max-height:72vh;overflow:auto}
  .toast{position:fixed;right:18px;bottom:18px;background:#28a745;color:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.18);z-index:2147483647;opacity:1;transition:opacity .3s,transform .25s}
  .toast.error{background:#dc3545}
  .row .controls button{padding:6px 8px;border-radius:6px;font-size:13px}
  @media (min-width:1200px){ .row{padding:12px} .text-input{font-size:14px} .note-input{height:40px} }
</style>
</head>
<body>
  <div class="container">
    <h1>Quản lý Text</h1>

    <div class="board" id="board">
      <div class="col" id="col-left">
        <h2>STT 1 → 9</h2>
        <div id="left-rows"></div>
      </div>

      <div class="col" id="col-right">
        <h2>STT 10 → 18</h2>
        <div id="right-rows"></div>
      </div>
    </div>

    <div style="text-align:center;margin-top:14px">
      <button class="add-row-btn" onclick="resetToDefault()">Reset 18 rows</button>
    </div>

    <div class="footer" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div class="small">Tổng số lần dán: <strong id="total-paste">0</strong></div>
        <div class="small">Tổng số link duy nhất: <strong id="total-links">0</strong></div>
        <div><button onclick="showLinksModal()" style="padding:7px 12px;border-radius:6px;border:none;background:#007bff;color:#fff;cursor:pointer">Xem Links</button></div>
      </div>
    </div>

    <div id="links-modal">
      <h3>Danh sách link</h3>
      <ul id="links-list"></ul>
      <div style="margin-top:8px">
        <button onclick="deleteAllLinks()" style="background:#dc3545;color:#fff;padding:8px 12px;border:none;border-radius:6px;cursor:pointer">Xóa tất cả</button>
        <button onclick="closeLinksModal()" style="padding:8px 12px;border-radius:6px;border:none;cursor:pointer">Đóng</button>
      </div>
    </div>
  </div>

<script>
/* ========== CONFIG ========== */
const API_URL = 'https://844aace9e015.ngrok-free.app/push'; // <-- đổi nếu cần
const SECRET_TOKEN = 'MY_SECRET_TOKEN_ChangeMe'; // <-- đổi giống server
const MAX_ROWS = 18;
const LEFT_COUNT = 9;

/* ========== state ========== */
let rowData = [];
let pasteCounts = [];
let copyCounts = [];
let uniqueLinks = [];

function storageKey(){ return 'textManager_2col_v1' }
function isValidUrl(s){ return /^(https?:\/\/[^\s/$.?#].[^\s]*)$/i.test(String(s||'').trim()) }

function saveState(){
  const payload = { rowData, pasteCounts, copyCounts, uniqueLinks, ts: new Date().toISOString() };
  localStorage.setItem(storageKey(), JSON.stringify(payload));
}
function loadState(){
  const raw = localStorage.getItem(storageKey());
  if(!raw){
    rowData = Array(MAX_ROWS).fill(0).map(()=>({ text:'', note:'', agent:'', stt: null }));
    pasteCounts = Array(MAX_ROWS).fill(0);
    copyCounts = Array(MAX_ROWS).fill(0);
    uniqueLinks = [];
    renderAll(); updateTotals(); return;
  }
  try{
    const obj = JSON.parse(raw);
    rowData = obj.rowData && obj.rowData.length===MAX_ROWS ? obj.rowData.map(r => ({ text:r.text||'', note:r.note||'', agent:r.agent||'', stt: r.stt || null })) : (Array(MAX_ROWS).fill(0).map(()=>({ text:'', note:'', agent:'', stt: null })));
    pasteCounts = obj.pasteCounts && obj.pasteCounts.length===MAX_ROWS ? obj.pasteCounts : Array(MAX_ROWS).fill(0);
    copyCounts = obj.copyCounts && obj.copyCounts.length===MAX_ROWS ? obj.copyCounts : Array(MAX_ROWS).fill(0);
    uniqueLinks = obj.uniqueLinks || [];
  }catch(e){
    rowData = Array(MAX_ROWS).fill(0).map(()=>({ text:'', note:'', agent:'', stt: null }));
    pasteCounts = Array(MAX_ROWS).fill(0);
    copyCounts = Array(MAX_ROWS).fill(0);
    uniqueLinks = [];
  }
  renderAll(); updateTotals();
}

function buildAgentSelect(selected){
  let s = '<select class="agent-select">';
  for(let i=1;i<=MAX_ROWS;i++) s += `<option value="${i}" ${String(i)===String(selected)?'selected':''}>Agent ${i}</option>`;
  s += '</select>';
  return s;
}

function makeRowHtml(index){
  const id = index+1;
  const data = rowData[index] || { text:'', note:'', agent:'', stt: null };
  const displayStt = (data.stt !== null && data.stt !== undefined && String(data.stt).trim() !== '') ? data.stt : id;
  const textEsc = (data.text||'').replace(/"/g,'&quot;');
  const agentHtml = buildAgentSelect(data.agent || '');
  return `
    <div class="row" data-id="${id}">
      <div class="row-number" title="Double-click để sửa STT">${displayStt}</div>
      <input class="text-input" value="${textEsc}" placeholder="Nhập link hoặc văn bản..." />
      <div style="display:flex;align-items:center;gap:8px;width:100%;justify-content:flex-end">
        <div class="controls">
          <button class="button paste-btn" onclick="pasteText(${id})">Dán</button>
          <button class="button send-btn" onclick="sendToAgent(${id})">Gửi</button>
          <button class="button copy-btn" onclick="copyText(${id})">Copy</button>
          <button class="button delete-btn" onclick="deleteText(${id})">Delete</button>
        </div>
        <div class="counts">
          <div class="paste-count">Dán: ${pasteCounts[id-1]||0} lần</div>
          <div class="copy-count">Copy: ${copyCounts[id-1]||0} lần</div>
        </div>
        ${agentHtml}
        <textarea class="note-input" placeholder="Ghi chú...">${data.note||''}</textarea>
      </div>
    </div>
  `;
}

function renderAll(){
  const left = document.getElementById('left-rows');
  const right = document.getElementById('right-rows');
  left.innerHTML = ''; right.innerHTML = '';

  for(let i=0;i<LEFT_COUNT;i++){
    const wrap = document.createElement('div');
    wrap.innerHTML = makeRowHtml(i);
    left.appendChild(wrap.firstElementChild);
  }
  for(let i=LEFT_COUNT;i<MAX_ROWS;i++){
    const wrap = document.createElement('div');
    wrap.innerHTML = makeRowHtml(i);
    right.appendChild(wrap.firstElementChild);
  }

  // attach events
  document.querySelectorAll('.row').forEach(rowEl => {
    const id = parseInt(rowEl.getAttribute('data-id'));
    const idx = id-1;
    const input = rowEl.querySelector('.text-input');
    input.addEventListener('input', e => { rowData[idx].text = e.target.value; saveState(); });

    input.title = rowData[idx].text || '';

    const select = rowEl.querySelector('.agent-select');
    select.addEventListener('change', e => { rowData[idx].agent = e.target.value; saveState(); });

    const note = rowEl.querySelector('.note-input');
    note.addEventListener('input', e => { rowData[idx].note = e.target.value; saveState(); });

    // double-click on STT to edit displayed number (no reorder)
    const rn = rowEl.querySelector('.row-number');
    rn.addEventListener('dblclick', ()=> startEditSTTinline(rowEl));
  });
}

function updateTotals(){
  const totalPaste = pasteCounts.reduce((s,c)=>s+(c||0),0);
  document.getElementById('total-paste').textContent = totalPaste;
  document.getElementById('total-links').textContent = (uniqueLinks||[]).length;
}

/* ========== actions ========== */
async function pasteText(rowId){
  const idx = rowId-1;
  try{
    const txt = await navigator.clipboard.readText();
    rowData[idx].text = txt;
    pasteCounts[idx] = (pasteCounts[idx]||0)+1;
    copyCounts[idx] = (copyCounts[idx]||0)+1;
    if(isValidUrl(txt) && !uniqueLinks.some(u=>u.url===txt)) uniqueLinks.push({ url: txt, timestamp: new Date().toISOString() });
    saveState();
    renderAll();
    updateTotals();
    showToast('Đã dán');
  }catch(e){ console.error(e); alert('Lỗi dán: kiểm tra quyền clipboard'); }
}

function copyText(rowId){
  const idx = rowId-1;
  const text = rowData[idx].text || '';
  navigator.clipboard.writeText(text).then(()=>{
    copyCounts[idx] = (copyCounts[idx]||0)+1;
    saveState();
    renderAll();
    updateTotals();
    showToast('Đã copy');
  }).catch(e => { alert('Lỗi copy: '+e.message); });
}

function deleteText(rowId){
  const idx = rowId-1;
  rowData[idx].text = '';
  rowData[idx].note = '';
  rowData[idx].agent = '';
  rowData[idx].stt = null;
  pasteCounts[idx] = 0;
  copyCounts[idx] = 0;
  saveState();
  renderAll();
  updateTotals();
  showToast('Đã xóa');
}

async function sendToAgent(rowId){
  const idx = rowId-1;
  const link = (rowData[idx].text||'').trim();
  if(!link){ showToast('Chưa có link để gửi', true); return; }
  if(!isValidUrl(link) && !confirm('Link có vẻ không chuẩn http(s). Vẫn gửi?')) return;

  const chosen = rowData[idx].agent && rowData[idx].agent.trim() ? rowData[idx].agent.trim() : null;
  const fallback = localStorage.getItem('nreer_agent_id') || null;
  const agentTo = chosen || fallback || '1';

  const payload = { token: SECRET_TOKEN, targetAgent: agentTo, link };
  try{
    const resp = await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const j = await resp.json().catch(()=>({ ok:false, error:'invalid_json' }));
    if(resp.ok && j.ok){
      showToast(`Đã gửi tới Agent ${agentTo}`);
    } else {
      showToast('Gửi thất bại: ' + (j.error || JSON.stringify(j)), true);
    }
  }catch(e){
    console.error(e);
    showToast('Lỗi khi gửi', true);
  }
}

/* ========== Inline STT edit (no reorder) ========== */
function startEditSTTinline(rowEl){
  const rn = rowEl.querySelector('.row-number');
  const id = parseInt(rowEl.getAttribute('data-id'));
  const idx = id-1;
  // create numeric input
  const inp = document.createElement('input');
  inp.type = 'text';
  inp.value = (rowData[idx] && rowData[idx].stt !== null && rowData[idx].stt !== undefined && String(rowData[idx].stt).trim() !== '') ? String(rowData[idx].stt) : String(id);
  inp.style.width = '46px';
  inp.style.height = '34px';
  inp.style.fontWeight = '700';
  inp.style.borderRadius = '6px';
  inp.style.textAlign = 'center';
  inp.className = 'stt-edit-input';
  rn.replaceWith(inp);
  inp.focus();
  inp.select();

  function finish(){
    const raw = inp.value.trim();
    // if empty -> clear custom stt (revert to default id)
    if(raw === ''){
      rowData[idx].stt = null;
    } else {
      // accept any string (user wanted visible text) but sanitize length
      const val = raw.slice(0, 6); // limit length to avoid layout break
      rowData[idx].stt = val;
    }
    saveState();
    renderAll();
  }

  inp.addEventListener('blur', finish);
  inp.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){ inp.blur(); }
    if(e.key === 'Escape'){ renderAll(); }
  });
}

/* ========== links modal ========== */
function showLinksModal(){
  const list = document.getElementById('links-list');
  list.innerHTML = '';
  if((uniqueLinks||[]).length===0) list.innerHTML = '<li>Chưa có link nào</li>';
  else {
    uniqueLinks.forEach(u => {
      const li = document.createElement('li');
      li.style.padding = '6px 0';
      li.innerHTML = `<div style="display:flex;justify-content:space-between;gap:8px"><div style="width:78%">${u.url}</div><small style="color:#666">${new Date(u.timestamp).toLocaleTimeString()}</small><div><button style="margin-left:8px;padding:6px 10px;background:#dc3545;color:#fff;border:none;border-radius:6px;cursor:pointer" onclick="removeLink('${u.url.replace(/'/g,"\\'")}')">Xóa</button></div></div>`;
      list.appendChild(li);
    });
  }
  document.getElementById('links-modal').style.display = 'block';
}
function closeLinksModal(){ document.getElementById('links-modal').style.display = 'none' }
function removeLink(url){ uniqueLinks = uniqueLinks.filter(u=>u.url!==url); saveState(); showLinksModal(); updateTotals(); }
function deleteAllLinks(){ uniqueLinks = []; saveState(); showLinksModal(); updateTotals(); }

function showToast(msg, isError=false){
  const t = document.createElement('div');
  t.className = 'toast' + (isError ? ' error' : '');
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(()=>{ t.style.opacity = '0'; t.style.transform = 'translateY(8px)'; }, 1200);
  setTimeout(()=> t.remove(), 1700);
}

function resetToDefault(){
  if(!confirm('Reset toàn bộ dữ liệu về 18 hàng trống?')) return;
  localStorage.removeItem(storageKey());
  loadState();
  showToast('Đã reset');
}

/* init */
window.addEventListener('load', ()=>{ loadState(); setInterval(()=>updateTotals(),1000); });
window.__textTwoCol = { loadState, saveState, sendToAgent, deleteAllLinks };
</script>
</body>
</html>
